<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin - Categorías</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
</head>
<body>
  <div th:replace="fragments/header :: header"></div>

  <div class="container mt-4">
        <h1>Administrar Categorías</h1>

        <div class="mb-3">
            <a th:href="@{/admin/productos}" class="btn btn-outline-primary">Mostrar todos los productos</a>
        </div>


    <form th:action="@{/admin/categorias/crear}" method="post" class="mb-3 row g-2 align-items-end">
      <div class="col-md-4">
        <label for="nombre" class="form-label">Nombre</label>
        <input id="nombre" type="text" name="nombre" placeholder="Nombre" class="form-control" required />
      </div>
      <div class="col-md-6">
        <label for="descripcion" class="form-label">Descripción</label>
        <input id="descripcion" type="text" name="descripcion" placeholder="Descripción" class="form-control" />
      </div>
      <div class="col-md-2">
        <button class="btn btn-primary">Crear</button>
      </div>
    </form>

    <div th:if="${categorias == null or #lists.isEmpty(categorias)}">
      <p class="text-muted">No hay categorías todavía. Crea una para empezar.</p>
    </div>

    <ul class="list-group" th:if="${categorias != null and !#lists.isEmpty(categorias)}">
      <li class="list-group-item" th:each="c : ${categorias}">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <div class="static-info">
              <h5 class="mb-1" th:text="${c.nombre}"></h5>
              <small class="text-muted d-block mb-2" th:text="${c.descripcion}"></small>
            </div>
            <!-- edit form (hidden) -->
            <form th:action="@{/admin/categorias/editar}" method="post" class="edit-form d-none">
              <input type="hidden" name="id" th:value="${c.id}" />
              <div class="row g-2 align-items-end">
                <div class="col-md-4">
                  <label th:for="${'nombre-c-' + c.id}" class="form-label visually-hidden">Nombre</label>
                  <input th:id="${'nombre-c-' + c.id}" type="text" name="nombre" th:value="${c.nombre}" class="form-control" required />
                </div>
                <div class="col-md-6">
                  <label th:for="${'desc-c-' + c.id}" class="form-label visually-hidden">Descripción</label>
                  <input th:id="${'desc-c-' + c.id}" type="text" name="descripcion" th:value="${c.descripcion}" class="form-control" />
                </div>
                <div class="col-md-2">
                  <button class="btn btn-sm btn-success">Guardar</button>
                  <button type="button" class="btn btn-sm btn-secondary btn-cancel-edit">Cancelar</button>
                </div>
              </div>
            </form>
          </div>

          <div class="ms-3 d-flex align-items-start">
            <button class="btn btn-sm btn-outline-secondary me-2 btn-edit">Editar</button>
            <form th:action="@{/admin/categorias/eliminar}" method="post" class="d-inline me-2">
              <input type="hidden" name="id" th:value="${c.id}" />
              <button class="btn btn-sm btn-outline-danger" onclick="return confirm('¿Eliminar categoría?')">Eliminar</button>
            </form>
            <!-- Gestionar productos de esta categoría -->
            <a th:href="@{/admin/productos(categoriaId=${c.id})}" class="btn btn-sm btn-outline-primary">Gestionar productos</a>
          </div>
        </div>
      </li>
    </ul>

    <div class="mt-3">
       <a th:href="@{/admin/productos}" class="btn btn-secondary">Gestionar productos</a>
     </div>

    <script>
      // Toggle inline edit form
      document.addEventListener('click', function(e){
        // Mostrar formulario de edición
        if(e.target && e.target.classList.contains('btn-edit')){
          const li = e.target.closest('li');
          const form = li.querySelector('.edit-form');
          const staticBlock = li.querySelector('.static-info');
          if(form) {
            form.classList.remove('d-none');
            // poner foco en el primer input
            const firstInput = form.querySelector('input[name="nombre"]');
            if(firstInput) { firstInput.focus(); }
          }
          if(staticBlock) {
            // ocultar el bloque que contiene h5 y small (primer hijo div)
            staticBlock.style.display = 'none';
          }
          // ocultar el botón Edit mientras editas
          e.target.style.display = 'none';
        }

        // Cancelar edición
        if(e.target && e.target.classList.contains('btn-cancel-edit')){
          const li = e.target.closest('li');
          const form = li.querySelector('.edit-form');
          const staticBlock = li.querySelector('.static-info');
          if(form) { form.classList.add('d-none'); }
          if(staticBlock) { staticBlock.style.display = 'block'; }
          // volver a mostrar el botón Edit
          const editBtn = li.querySelector('.btn-edit');
          if(editBtn) editBtn.style.display = 'inline-block';
        }
      });
     </script>
  </div>
  <div th:replace="fragments/footer :: footer"></div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
