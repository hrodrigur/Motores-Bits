<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Perfil - Motores & Bits</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
</head>
<body>
  <div th:replace="fragments/header :: header"></div>
  <div class="container mt-4">
    <h1>Perfil</h1>

    <div th:if="${saved}" class="alert alert-success">Perfil actualizado correctamente.</div>

    <!-- Información general siempre visible -->
    <div class="card mb-3">
      <div class="card-body">
        <h5 th:text="${usuario.nombre}"></h5>
        <p th:text="${usuario.email}"></p>
        <p><strong>Dirección:</strong>
          <span th:if="${usuario.direccion != null and usuario.direccion != ''}" th:text="${usuario.direccion}"></span>
          <span th:unless="${usuario.direccion != null and usuario.direccion != ''}">No especificado</span>
        </p>
        <p><strong>Teléfono:</strong>
          <span th:if="${usuario.telefono != null and usuario.telefono != ''}" th:text="${usuario.telefono}"></span>
          <span th:unless="${usuario.telefono != null and usuario.telefono != ''}">No especificado</span>
        </p>

        <!-- Botón para mostrar el formulario de edición de dirección/telefono -->
        <button class="btn btn-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#editProfile" aria-expanded="false" aria-controls="editProfile">
          Editar perfil
        </button>
          <form th:action="@{/logout}" method="post" class="d-inline">
              <button type="submit" class="btn btn-danger ms-2">Cerrar sesión</button>
          </form>
      </div>
    </div>

    <!-- Formulario colapsable para añadir/editar dirección y teléfono -->
    <div class="collapse" id="editProfile">
      <div class="card card-body mb-3">
        <form method="post" action="/perfil" th:action="@{/perfil}">
          <!-- Si la aplicación usa Spring Security, incluir el token CSRF -->
          <input type="hidden" th:if="${_csrf != null}" name="${_csrf.parameterName}" th:value="${_csrf.token}" />

          <div class="mb-3">
            <label for="direccion" class="form-label">Dirección</label>
            <input id="direccion" class="form-control" type="text" name="direccion" th:value="${usuario.direccion}" />
          </div>
          <div class="mb-3">
            <label for="telefono" class="form-label">Teléfono</label>
            <input id="telefono" class="form-control" type="tel" name="telefono" th:value="${usuario.telefono}" pattern="[0-9]{9}" inputmode="numeric"
                   title="El telefono debe de tener 9 digitos y que todos sean numericos" required />
          </div>
          <button class="btn btn-primary" type="submit">Guardar</button>
        </form>
      </div>
    </div>

    <h3>Mis pedidos</h3>
    <div th:if="${pedidos}">
      <ul class="list-group">
        <li class="list-group-item d-flex justify-content-between align-items-center" th:each="p : ${pedidos}">
          <div>
            <strong th:text="${p.id}"></strong> - <span th:text="${p.estado}"></span> - <span th:text="${p.total}"></span>
          </div>
          <div>
            <form th:action="@{/perfil/pedido/eliminar}" method="post" class="d-inline">
              <input type="hidden" name="idPedido" th:value="${p.id}" />
              <input type="hidden" th:if="${_csrf != null}" name="${_csrf.parameterName}" th:value="${_csrf.token}" />
              <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('¿Eliminar este pedido? Esta operación no se puede deshacer.')">Eliminar</button>
            </form>
          </div>
        </li>
      </ul>
    </div>

  </div>
  <div th:replace="fragments/footer :: footer"></div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script th:inline="javascript">
    /*<![CDATA[*/
    /* Si la variable 'saved' no está presente, evaluamos a false de forma segura. */
    var perfilSaved = /*[[${saved}]]*/ false;
    if (perfilSaved === true) {
      // cerrar collapse
      var collapseEl = document.getElementById('editProfile');
      if (collapseEl && collapseEl.classList.contains('show')) {
        // Usar la API de Bootstrap para cerrar si está abierto
        var bsCollapse = bootstrap.Collapse.getOrCreateInstance(collapseEl);
        bsCollapse.hide();
      }
    }
    /*]]>*/
  </script>
</body>
</html>
